@using MYCV.Domain.Enums
@model List<MYCV.Application.DTOs.UserExperienceDto>

@{
    ViewData["Title"] = "Work Experience";
    var currentStep = (int)CvStep.WorkExperience;
    var completedSteps = new List<int> { (int)CvStep.PersonalInformation, (int)CvStep.Education };
}

<section class="py-5 bg-light">
    <div class="container">
        <div class="row mb-4">
            <div class="col text-center">
                <h2 class="fw-bold">Work Experience</h2>
                <p class="text-muted">Add your professional experience step by step</p>
            </div>
        </div>

        <div class="row">
            <!-- LEFT STEP NAVIGATION -->
            <div class="col-lg-4 mb-4">
                @await Component.InvokeAsync("CvStepNavigation", new { currentStep = currentStep, completedSteps = completedSteps })
            </div>

            <!-- RIGHT CONTENT AREA -->
            <div class="col-lg-8" style="max-height: 80vh; overflow-y: auto;">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="fw-semibold mb-0">Step <span id="currentStepDisplay">@currentStep</span></h4>
                            <span class="badge bg-primary" id="stepBadge">In Progress</span>
                        </div>

                        <div class="accordion" id="experienceAccordion">
                            @for (int i = 0; i < Model.Count; i++)
                            {
                                var exp = Model[i];
                                <div class="accordion-item step-form" data-step="@currentStep">
                                    <h2 class="accordion-header" id="headingExp@i">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#collapseExp@i"
                                                aria-expanded="false"
                                                aria-controls="collapseExp@i">
                                            Experience @(@i + 1)
                                        </button>
                                    </h2>
                                    <div id="collapseExp@i" class="accordion-collapse collapse"
                                         aria-labelledby="headingExp@i">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Company</label>
                                                    <input type="text" name="Model[@i].Company" class="form-control"
                                                           value="@exp.Company" required />
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Position</label>
                                                    <input type="text" name="Model[@i].Position" class="form-control"
                                                           value="@exp.Position" required />
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Department</label>
                                                    <input type="text" name="Model[@i].Department" class="form-control"
                                                           value="@exp.Department" />
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Location</label>
                                                    <input type="text" name="Model[@i].Location" class="form-control"
                                                           value="@exp.Location" />
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Employment Type</label>
                                                    <select name="Model[@i].EmploymentType" class="form-select" required>
                                                        @foreach (EmploymentType type in Enum.GetValues(typeof(EmploymentType)))
                                                        {
                                                            if (exp.EmploymentType == type)
                                                            {
                                                                <option value="@type" selected>@type</option>
                                                            }
                                                            else
                                                            {
                                                                <option value="@type">@type</option>
                                                            }
                                                        }
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Start Date</label>
                                                    <input type="date" name="Model[@i].StartDate" class="form-control"
                                                           value="@exp.StartDate.ToString("yyyy-MM-dd")" required />
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">End Date</label>
                                                    <input type="date" name="Model[@i].EndDate" class="form-control"
                                                           value="@(exp.EndDate.HasValue ? exp.EndDate.Value.ToString("yyyy-MM-dd") : "")" />
                                                </div>
                                                <div class="col-md-12">
                                                    <label class="form-label">Responsibilities</label>
                                                    <textarea name="Model[@i].Responsibilities" class="form-control" rows="2">@exp.Responsibilities</textarea>
                                                </div>
                                                <div class="col-md-12">
                                                    <label class="form-label">Remarks</label>
                                                    <textarea name="Model[@i].Remarks" class="form-control" rows="2">@exp.Remarks</textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary btn-prev-step">← Previous</button>
                            <button type="button" class="btn btn-success btn-add-exp">+ Add Experience</button>
                            <button type="button" class="btn btn-primary btn-next-step">Save & Continue →</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
<script>
    let currentStep = @currentStep;

    // Add new experience dynamically
    document.querySelector('.btn-add-exp').addEventListener('click', function () {
        const accordion = document.getElementById('experienceAccordion');
        const index = accordion.children.length;
        const newItem = document.createElement('div');
        newItem.className = 'accordion-item step-form';
        newItem.dataset.step = currentStep;
        newItem.innerHTML = `
            <h2 class="accordion-header" id="headingExp${index}">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseExp${index}"
                        aria-expanded="false"
                        aria-controls="collapseExp${index}">
                    Experience ${index + 1}
                </button>
            </h2>
            <div id="collapseExp${index}" class="accordion-collapse collapse"
                 aria-labelledby="headingExp${index}">
                <div class="accordion-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Company</label>
                            <input type="text" name="Model[${index}].Company" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Position</label>
                            <input type="text" name="Model[${index}].Position" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Department</label>
                            <input type="text" name="Model[${index}].Department" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Location</label>
                            <input type="text" name="Model[${index}].Location" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Employment Type</label>
                            <select name="Model[${index}].EmploymentType" class="form-select" required>
                                <option value="">Select...</option>
                                <option value="FullTime">FullTime</option>
                                <option value="PartTime">PartTime</option>
                                <option value="Contract">Contract</option>
                                <option value="Internship">Internship</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Start Date</label>
                            <input type="date" name="Model[${index}].StartDate" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">End Date</label>
                            <input type="date" name="Model[${index}].EndDate" class="form-control" />
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Responsibilities</label>
                            <textarea name="Model[${index}].Responsibilities" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Remarks</label>
                            <textarea name="Model[${index}].Remarks" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        `;
        accordion.appendChild(newItem);
    });

    // TODO: Add Save & Continue logic here (POST to controller)
    document.querySelector('.btn-next-step').addEventListener('click', function () {
        // Collect data from the accordion and POST via fetch/ajax
    });

    // Previous Step
    document.querySelector('.btn-prev-step').addEventListener('click', function () {
        window.location.href = '/CvBuilder/Step?stepNumber=' + @((int)CvStep.Education);
    });
</script>
}
